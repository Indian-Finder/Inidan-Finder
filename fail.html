<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>View Fail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--text:#f9fafb;--muted:#9ca3af;--bg:#020617;--card:rgba(15,23,42,.92)}
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Inter",sans-serif;
      background:linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.75)), url("india-flag.png");
      background-size:cover;background-position:center;background-attachment:fixed;
      color:var(--text);
      display:flex;align-items:center;justify-content:center;
      padding:18px;
    }
    .shell{width:100%;max-width:1200px}
    .card{
      background:var(--card);
      border:1px solid rgba(148,163,184,.35);
      border-radius:1.6rem;
      box-shadow:0 18px 40px rgba(0,0,0,.55);
      overflow:hidden;
      backdrop-filter:blur(10px);
    }
    header{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:14px 16px;
      border-bottom:1px solid rgba(148,163,184,.25);
    }
    .title{
      font-weight:800;letter-spacing:.08em;text-transform:uppercase;
      font-size:.95rem;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:72vw;
    }
    .sub{font-size:.78rem;color:var(--muted)}
    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.45);
      background:rgba(2,6,23,.55);
      color:var(--text);
      padding:8px 12px;
      font-size:.8rem;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;align-items:center;gap:8px;
      transition:transform .12s ease, background .12s ease;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.06)}
    .btn.primary{
      border:none;
      background:linear-gradient(135deg,#f97316,#ec4899);
      color:#0b1020;
      font-weight:800;
    }
    .player{
      width:100%;
      aspect-ratio:16/9;
      background:#000;
      display:flex;align-items:center;justify-content:center;
      position:relative;
    }
    video,img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      background:#000;
    }
    .meta{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:12px 16px;
      border-top:1px solid rgba(148,163,184,.25);
      flex-wrap:wrap;
    }
    .leftmeta{min-width:240px}
    .failtitle{font-size:.95rem;font-weight:800}
    .author{font-size:.8rem;color:var(--muted);margin-top:2px}
    .rightmeta{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .toast{
      position:fixed;left:50%;bottom:22px;transform:translateX(-50%) translateY(120%);
      background:rgba(15,23,42,.96);
      border:1px solid rgba(148,163,184,.35);
      padding:8px 12px;border-radius:999px;
      font-size:.8rem;color:var(--muted);
      opacity:0;transition:transform .2s ease, opacity .2s ease;
      z-index:50;
    }
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <header>
        <div>
          <div class="title" id="headerTitle">View Fail</div>
          <div class="sub" id="headerSub">Loading‚Ä¶</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <a class="btn" href="index.html">‚¨Ö Back</a>
          <button class="btn" id="copyBtn">üîó Copy link</button>
          <button class="btn primary" id="shareXBtn">üê¶ Share to X</button>
        </div>
      </header>

      <div class="player" id="player">
        <div style="color:#9ca3af;font-size:.9rem">Loading fail‚Ä¶</div>
      </div>

      <div class="meta">
        <div class="leftmeta">
          <div class="failtitle" id="failTitle">‚Äî</div>
          <div class="author" id="failAuthor"></div>
        </div>
        <div class="rightmeta">
          <a class="btn" id="downloadBtn" href="#" download>‚¨áÔ∏è Download</a>
          <button class="btn" id="nextBtn">üé≤ Next fail</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Copied!</div>

<script>
  const API_BASE = "https://inidan-finder-production-c13b.up.railway.app";

  const qs = new URLSearchParams(location.search);
  const id = qs.get("id");

  const player = document.getElementById("player");
  const headerTitle = document.getElementById("headerTitle");
  const headerSub = document.getElementById("headerSub");
  const failTitle = document.getElementById("failTitle");
  const failAuthor = document.getElementById("failAuthor");
  const downloadBtn = document.getElementById("downloadBtn");
  const copyBtn = document.getElementById("copyBtn");
  const shareXBtn = document.getElementById("shareXBtn");
  const nextBtn = document.getElementById("nextBtn");
  const toast = document.getElementById("toast");

  let failsCache = null;
  let currentFail = null;

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove("show"), 1400);
  }

  function inferMediaType(u){
    const url = (u||"").toLowerCase();
    if (url.match(/\.(png|jpg|jpeg|webp|gif)(\?|$)/)) return "image";
    return "video";
  }

  function absoluteUrl(u){
    if (!u) return "";
    return u.startsWith("http") ? u : `${API_BASE}${u}`;
  }

  function renderFail(f){
    currentFail = f;
    const mediaUrl = absoluteUrl(f.url || f.src);
    const mediaType = (f.mediaType || inferMediaType(mediaUrl)).toLowerCase();

    headerTitle.textContent = "View Fail";
    headerSub.textContent = f.id ? `Fail ID: ${f.id}` : "";

    failTitle.textContent = f.title || "Fail";
    failAuthor.textContent = f.author ? `by ${f.author}` : "";

    // download
    downloadBtn.href = mediaUrl;

    // player
    player.innerHTML = "";
    if (mediaType === "image") {
      const img = document.createElement("img");
      img.src = mediaUrl;
      img.alt = f.title || "Fail";
      player.appendChild(img);
    } else {
      const vid = document.createElement("video");
      vid.src = mediaUrl;
      vid.controls = true;
      vid.autoplay = true;
      vid.playsInline = true;
      player.appendChild(vid);
    }

    // Update meta tags for nicer embeds (best-effort)
    document.title = (f.title ? `${f.title} ‚Äì Fails` : "View Fail");
  }

  async function fetchFailById(failId){
    const r = await fetch(`${API_BASE}/api/fails/${encodeURIComponent(failId)}`);
    if (!r.ok) throw new Error("Fail not found");
    return r.json();
  }

  async function fetchAllFails(){
    if (failsCache) return failsCache;
    const r = await fetch(`${API_BASE}/api/fails`, { headers: {"Cache-Control":"no-cache"} });
    const j = await r.json();
    failsCache = Array.isArray(j) ? j : [];
    return failsCache;
  }

  async function pickRandomFailId(excludeId){
    const all = await fetchAllFails();
    if (!all.length) return null;
    if (all.length === 1) return all[0].id;
    let pick;
    do {
      pick = all[Math.floor(Math.random() * all.length)];
    } while (pick.id === excludeId);
    return pick.id;
  }

  copyBtn.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(location.href);
      showToast("Copied link ‚úÖ");
    } catch {
      showToast("Copy failed");
    }
  });

  shareXBtn.addEventListener("click", async () => {
    // simplest + reliable: open tweet intent with the link
    const text = currentFail?.title
      ? `${currentFail.title} üòÇ`
      : `New fail just dropped üòÇ`;
    const url = location.href;
    const intent = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
    window.open(intent, "_blank");
  });

  nextBtn.addEventListener("click", async () => {
    const nextId = await pickRandomFailId(currentFail?.id);
    if (!nextId) return showToast("No fails yet");
    location.href = `fail.html?id=${encodeURIComponent(nextId)}`;
  });

  (async () => {
    try{
      if (!id) {
        const nextId = await pickRandomFailId(null);
        if (!nextId) {
          headerSub.textContent = "No fails found yet.";
          player.innerHTML = `<div style="color:#9ca3af;font-size:.9rem">No fails yet. Upload one!</div>`;
          return;
        }
        location.replace(`fail.html?id=${encodeURIComponent(nextId)}`);
        return;
      }
      const f = await fetchFailById(id);
      renderFail(f);
    } catch(e){
      headerSub.textContent = "Fail not found.";
      player.innerHTML = `<div style="color:#9ca3af;font-size:.9rem">This fail doesn‚Äôt exist (or was deleted).</div>`;
    }
  })();
</script>
</body>
</html>
