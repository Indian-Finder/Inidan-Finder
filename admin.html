<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fails Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#020617;--card:#0b1120;--accent:#f97316;--accent2:#ec4899;
      --text:#e5e7eb;--muted:#9ca3af;--radius:1.2rem;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Inter",sans-serif;
      background:linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.7)), url("india-flag.png");
      background-size:cover;background-position:center;background-attachment:fixed;
      color:var(--text);display:flex;align-items:center;justify-content:center;padding:24px;
    }
    .shell{width:100%;max-width:1100px}
    .card{
      background:rgba(11,17,32,.96);border-radius:1.6rem;padding:22px 20px 20px;
      border:1px solid rgba(148,163,184,.4);backdrop-filter:blur(10px);
      box-shadow:0 18px 36px rgba(0,0,0,.6);
    }
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:10px}
    h1{font-size:1.3rem}
    .badge{font-size:.78rem;color:var(--muted)}
    .ghost-btn{
      border-radius:999px;border:1px solid rgba(148,163,184,.5);
      padding:6px 12px;font-size:.8rem;color:var(--muted);
      background:transparent;text-decoration:none;cursor:pointer;
      display:inline-flex;align-items:center;gap:4px;
    }
    .login-card{max-width:420px;margin:0 auto;text-align:left}
    label{font-size:.8rem;display:block;margin-bottom:4px;color:var(--muted)}
    input[type="password"]{
      width:100%;border-radius:.8rem;border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);color:var(--text);
      padding:10px 12px;font-size:.9rem;margin-bottom:10px;outline:none
    }
    input:focus{border-color:var(--accent);box-shadow:0 0 0 1px rgba(249,115,22,.4)}
    .primary-btn{
      border-radius:999px;border:none;padding:9px 16px;font-size:.9rem;font-weight:600;
      cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));color:#020617
    }
    .error{margin-top:6px;font-size:.78rem;color:#f97373}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .section{
      background:rgba(15,23,42,.96);border-radius:1rem;padding:10px 10px 8px;
      border:1px solid rgba(148,163,184,.3)
    }
    .list{max-height:600px;overflow-y:auto;padding-right:4px}
    .item-card{
      border-radius:.9rem;border:1px solid rgba(148,163,184,.25);
      padding:8px;margin-bottom:8px;background:rgba(15,23,42,.95);
      display:grid;grid-template-columns:160px minmax(0,1fr);gap:10px;font-size:.8rem
    }
    .thumb{
      width:100%;aspect-ratio:16/9;border-radius:.6rem;overflow:hidden;background:#000;
      display:flex;align-items:center;justify-content:center
    }
    .thumb video,.thumb img{width:100%;height:100%;object-fit:cover}
    .row-top{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
    .meta{color:var(--muted);margin-bottom:4px}
    .tiny{font-size:.72rem;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .danger-btn{
      border-radius:999px;border:1px solid rgba(248,113,113,.6);
      padding:6px 10px;font-size:.78rem;background:rgba(248,113,113,.12);
      color:#fecaca;cursor:pointer
    }
  </style>
</head>
<body>
<div class="shell">
  <div class="card">
    <header>
      <div>
        <h1>Fails Admin</h1>
        <div class="badge">Manage live fails (videos.json)</div>
      </div>
      <a href="index.html" class="ghost-btn">â¬… Site</a>
    </header>

    <!-- LOGIN VIEW -->
    <div id="loginView" class="login-card">
      <label for="adminPassword">Admin password</label>
      <input type="password" id="adminPassword" placeholder="Enter admin password" />
      <button class="primary-btn" id="loginBtn">Log in</button>
      <div id="loginError" class="error"></div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="dashboard" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;flex-wrap:wrap">
        <div class="tiny" id="countLabel"></div>
        <div style="display:flex;gap:8px">
          <button class="ghost-btn" id="refreshBtn">â†» Refresh</button>
          <button class="ghost-btn" id="logoutBtn">Log out</button>
        </div>
      </div>

      <div class="grid">
        <div class="section">
          <div class="list" id="failsList"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const API_BASE = "https://inidan-finder-production-c13b.up.railway.app";

  const loginView = document.getElementById("loginView");
  const dashboard = document.getElementById("dashboard");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const loginError = document.getElementById("loginError");
  const failsListEl = document.getElementById("failsList");
  const countLabel = document.getElementById("countLabel");

  function setLoggedInUI() {
    loginView.style.display = "none";
    dashboard.style.display = "block";
  }
  function setLoggedOutUI() {
    loginView.style.display = "block";
    dashboard.style.display = "none";
  }

  async function api(path, options = {}) {
    return fetch(`${API_BASE}${path}`, {
      ...options,
      credentials: "include",
      headers: {
        ...(options.headers || {})
      }
    });
  }

  async function login(password) {
    const res = await api("/api/admin/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password })
    });
    return res.ok;
  }

  async function logout() {
    await api("/api/admin/logout", { method: "POST" });
  }

  async function getStatus() {
    const res = await api("/api/admin/status");
    if (!res.ok) return { isAdmin: false };
    return res.json();
  }

  function renderFails(items) {
    failsListEl.innerHTML = "";
    countLabel.textContent = `${items.length} fails`;

    if (!items.length) {
      failsListEl.innerHTML = `<p class="tiny">No fails found.</p>`;
      return;
    }

    items.forEach(item => {
      const isImage = (item.url || "").match(/\.(png|jpg|jpeg|webp)$/i);

      const div = document.createElement("div");
      div.className = "item-card";
      div.innerHTML = `
        <div class="thumb">
          ${isImage
            ? `<img src="${API_BASE + item.url}" alt="">`
            : `<video src="${API_BASE + item.url}" muted playsinline></video>`}
        </div>
        <div>
          <div class="row-top">
            <div><strong>${item.title || "Untitled fail"}</strong></div>
            <div class="tiny">${item.createdAt ? new Date(item.createdAt).toLocaleString() : ""}</div>
          </div>
          <div class="meta">${item.author ? `From <strong style="color:var(--text)">${item.author}</strong>` : `<span class="tiny">Anonymous</span>`}</div>
          <div class="tiny">ID: ${item.id}</div>

          <div class="actions">
            <button class="danger-btn" data-del="${item.id}">ðŸ—‘ Delete</button>
          </div>
        </div>
      `;
      failsListEl.appendChild(div);
    });

    failsListEl.querySelectorAll("[data-del]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.del;
        if (!confirm("Delete this fail forever?")) return;
        const res = await api(`/api/admin/fails/${encodeURIComponent(id)}`, { method: "DELETE" });
        if (!res.ok) {
          alert("Delete failed");
          return;
        }
        await loadFails();
      });
    });
  }

  async function loadFails() {
    const res = await api("/api/admin/fails");
    if (!res.ok) {
      alert("Could not load fails (are you logged in?)");
      return;
    }
    const items = await res.json();
    renderFails(items);
  }

  loginBtn.addEventListener("click", async () => {
    const pwd = document.getElementById("adminPassword").value.trim();
    if (!pwd) { loginError.textContent = "Enter a password"; return; }
    loginError.textContent = "";

    const ok = await login(pwd);
    if (!ok) { loginError.textContent = "Invalid password"; return; }

    setLoggedInUI();
    await loadFails();
  });

  logoutBtn.addEventListener("click", async () => {
    await logout();
    setLoggedOutUI();
  });

  refreshBtn.addEventListener("click", loadFails);

  // Auto-check session
  (async () => {
    const s = await getStatus();
    if (s.isAdmin) {
      setLoggedInUI();
      await loadFails();
    } else {
      setLoggedOutUI();
    }
  })();
</script>
</body>
</html>



